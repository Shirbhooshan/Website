<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Smart Glass Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .ambient-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
            animation: float 20s infinite ease-in-out;
        }

        .orb1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #00d4ff, transparent);
            top: -200px;
            left: -200px;
        }

        .orb2 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, #9d00ff, transparent);
            bottom: -300px;
            right: -300px;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(50px, -50px) scale(1.1); }
            66% { transform: translate(-30px, 30px) scale(0.9); }
        }

        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
            position: relative;
            z-index: 1;
        }

        .hero-header {
            text-align: center;
            margin-bottom: 80px;
        }

        .hero-header h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            font-weight: 800;
            letter-spacing: 4px;
            background: linear-gradient(135deg, #00d4ff, #9d00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.5)); }
            50% { filter: drop-shadow(0 0 40px rgba(157, 0, 255, 0.7)); }
        }

        .hero-subtitle {
            font-size: 1.3rem;
            color: #00d4ff;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .hero-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 60px;
            max-width: 1400px;
            width: 100%;
            align-items: center;
        }

        .features-left, .features-right {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.4s ease;
        }

        .feature-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.6);
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .feature-card h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #00d4ff;
        }

        .feature-card p {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }

        .glass-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .glow-ring, .glow-ring-2 {
            position: absolute;
            border-radius: 50%;
            border: 2px solid;
            animation: pulse 3s ease-in-out infinite;
        }

        .glow-ring {
            width: 400px;
            height: 400px;
            border-color: rgba(0, 212, 255, 0.5);
        }

        .glow-ring-2 {
            width: 500px;
            height: 500px;
            border-color: rgba(157, 0, 255, 0.3);
            animation-delay: 1.5s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .hero-glass-img {
            width: 350px;
            height: auto;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.6));
            object-fit: contain;
            animation: levitate 4s ease-in-out infinite;
            transition: transform 0.3s ease;
        }

        .hero-glass-img:hover {
            transform: scale(1.1) translateY(-10px);
            filter: drop-shadow(0 0 50px rgba(0, 212, 255, 0.9));
        }

        @keyframes levitate {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .section {
            min-height: 100vh;
            padding: 80px 20px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .section-title {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 60px;
            background: linear-gradient(135deg, #00d4ff, #9d00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            width: 90%;
            max-width: 1200px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            padding: 40px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(0, 212, 255, 0.6);
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(0, 212, 255, 0.4);
        }

        .card h2 {
            margin-bottom: 20px;
            color: #00d4ff;
            font-size: 1.8rem;
        }

        .sensor-value {
            font-size: 4rem;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(135deg, #00d4ff, #9d00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .sensor-timestamp {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .card:hover .sensor-value {
            transform: scale(1.1);
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.6));
        }

        .full-width-card {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
        }

        input {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            color: #fff;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        button {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00d4ff, #9d00ff);
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 212, 255, 0.6);
        }

        button:active {
            transform: translateY(-1px) scale(0.98);
        }

        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }

        .log p {
            margin: 10px 0;
            padding: 12px;
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }

        .log-type.call {
            background: #ff4444;
        }

        .log-type.msg {
            background: #00d4ff;
        }

        .log-type.notif {
            background: #9d00ff;
        }

        .log-type.test {
            background: #00ff88;
        }

        .qr-entry {
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(157, 0, 255, 0.1);
            border-left: 3px solid #9d00ff;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
        }

        .qr-link {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #00d4ff, #9d00ff);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .qr-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.5);
        }

        .qr-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 8px;
        }

        .qr-badge.url {
            background: #00d4ff;
        }

        .qr-badge.text {
            background: #9d00ff;
        }

        .camera-container {
            position: relative;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(0, 212, 255, 0.2);
        }

        .camera-stream {
            width: 100%;
            height: auto;
            display: none;
            border-radius: 10px;
        }

        .camera-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 40px;
        }

        .camera-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
            animation: pulse-icon 2s ease-in-out infinite;
        }

        @keyframes pulse-icon {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .camera-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px 0;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
        }

        .camera-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .camera-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
            animation: blink 2s infinite;
        }

        .camera-status-dot.live {
            background: #00ff88;
            animation: none;
        }

        .fps-counter {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            font-family: 'Courier New', monospace;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .connection-status:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.6);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            animation: blink 2s infinite;
        }

        .status-dot.connected {
            background: #00ff88;
            animation: none;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        @media (max-width: 1024px) {
            .hero-content {
                grid-template-columns: 1fr;
                gap: 40px;
            }
            
            .features-left, .features-right {
                max-width: 600px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="connection-status">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">Connecting...</span>
</div>

<div class="ambient-orb orb1"></div>
<div class="ambient-orb orb2"></div>

<!-- PAGE 1: HERO & FEATURES -->
<section class="hero">
    <div class="hero-header">
        <h1>SMART GLASS AR INTERFACE</h1>
        <p class="hero-subtitle">Next-Generation Augmented Reality Experience</p>
    </div>
    
    <div class="hero-content">
        <!-- Left Features -->
        <div class="features-left">
            <div class="feature-card">
                <div class="feature-icon">üå°Ô∏è</div>
                <h3>Real-Time Monitoring</h3>
                <p>Track temperature and humidity with precision DHT11 sensors integrated into the smart glass system</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">üì±</div>
                <h3>Wireless Control</h3>
                <p>Connect seamlessly via ESP32 WiFi for instant data transmission and remote control</p>
            </div>
        </div>
        
        <!-- Center Glass -->
        <div class="glass-container">
            <div class="glow-ring"></div>
            <div class="glow-ring-2"></div>
            <img src="/images/glass.png" alt="Smart Glass" class="hero-glass-img">
        </div>
        
        <!-- Right Features -->
        <div class="features-right">
            <div class="feature-card">
                <div class="feature-icon">üñ•Ô∏è</div>
                <h3>OLED Display</h3>
                <p>Crystal clear micro-display shows notifications, data, and custom messages in your field of view</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">‚ö°</div>
                <h3>Low Power Design</h3>
                <p>Efficient power management ensures all-day battery life for extended use</p>
            </div>
        </div>
    </div>
</section>

<!-- PAGE 2: DASHBOARD -->
<section class="section">
    <h2 class="section-title">Live Dashboard</h2>

    <!-- Sensor Readings Grid -->
    <div class="dashboard-grid">
        <div class="card sensor">
            <h2>üå° Temperature</h2>
            <div class="sensor-value" id="temp">-- ¬∞C</div>
            <div class="sensor-timestamp" id="tempTime">Waiting for data...</div>
        </div>

        <div class="card sensor">
            <h2>üíß Humidity</h2>
            <div class="sensor-value" id="hum">-- %</div>
            <div class="sensor-timestamp" id="humTime">Waiting for data...</div>
        </div>
    </div>

    <!-- Camera Feed Card -->
    <div class="card full-width-card">
        <h2>üì∑ Live Camera Feed</h2>
        <div class="camera-container">
            <img 
                id="cameraStream" 
                class="camera-stream"
                alt="ESP32 Camera Feed"
            />
            <div id="cameraPlaceholder" class="camera-placeholder">
                <div class="camera-placeholder-icon">üì∑</div>
                <p id="cameraStatusText">Waiting for camera feed...</p>
                <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.7;">ESP32-CAM will upload frames to Firebase</p>
            </div>
        </div>
        <div class="camera-status-bar">
            <div class="camera-status-indicator">
                <div class="camera-status-dot" id="camStatusDot"></div>
                <span id="camStatusLabel">Offline</span>
            </div>
            <div class="fps-counter" id="fpsCounter">FPS: 0.0</div>
            <div class="fps-counter" id="lastFrameTime">Last frame: Never</div>
        </div>
    </div>

    <!-- Send Message Card -->
    <div class="card full-width-card">
        <h2>üì§ Send Message to Smart Glass OLED</h2>
        <input id="msg" placeholder="Type your message here..." />
        <button onclick="sendMessage()">Send to Glasses</button>
    </div>

    <!-- Notification Log Card -->
    <div class="card full-width-card">
        <h2>üìú Notification Log</h2>
        <div class="log" id="log">
            <p style="opacity:0.6;">No notifications yet. Waiting for data...</p>
        </div>
    </div>

    <!-- QR Code Detection Log -->
    <div class="card full-width-card">
        <h2>üì∑ QR Code Detections</h2>
        <div class="log" id="qrLog">
            <p style="opacity:0.6;">No QR codes detected yet...</p>
        </div>
    </div>

</section>

<footer>
    ESP32 Smart Glass ‚Ä¢ Sci-Fi Interface ‚Ä¢ Powered by IoT & Firebase
</footer>

<script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase configuration for Smart Glasses project
    const firebaseConfig = {
        apiKey: "AIzaSyD9qxxWPMbt9hFUOfHsW6KXBOj88ig3psE",
        authDomain: "smart-glasses-ff6d1.firebaseapp.com",
        databaseURL: "https://smart-glasses-ff6d1-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "smart-glasses-ff6d1",
        storageBucket: "smart-glasses-ff6d1.firebasestorage.app",
        messagingSenderId: "461571246400",
        appId: "1:461571246400:web:fe3eeba3ad4883bb41d2a5",
        measurementId: "G-EVNL2R7FSX"
    };

    // Initialize Firebase
    let app, database;
    let isConnected = false;
    
    try {
        app = initializeApp(firebaseConfig);
        database = getDatabase(app);
        
        // Monitor connection status
        const connectedRef = ref(database, '.info/connected');
        onValue(connectedRef, (snapshot) => {
            isConnected = snapshot.val() === true;
            updateConnectionStatus(isConnected);
        });
        
    } catch (error) {
        console.error("Firebase initialization error:", error);
        updateConnectionStatus(false);
        showErrorMessage("Firebase connection failed. Please check your configuration.");
    }

    // Show error message
    function showErrorMessage(message) {
        const logDiv = document.getElementById('log');
        logDiv.innerHTML = `<p style="color: #ff4444; opacity: 1;">${message}</p>`;
    }

    // Update connection status indicator
    function updateConnectionStatus(connected) {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        if (connected) {
            statusDot.classList.add('connected');
            statusText.textContent = 'Connected';
        } else {
            statusDot.classList.remove('connected');
            statusText.textContent = 'Disconnected';
        }
    }

    // Listen for sensor readings from ESP32
    // ESP32 uploads to: /smartglasses/readings with {temperature, humidity, timestamp}
    const readingsRef = ref(database, 'smartglasses/readings');
    onValue(readingsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            console.log("Received sensor data:", data);
            
            // Update temperature
            if (data.temperature !== undefined && data.temperature !== null) {
                document.getElementById('temp').textContent = data.temperature + ' ¬∞C';
            }
            
            // Update humidity
            if (data.humidity !== undefined && data.humidity !== null) {
                document.getElementById('hum').textContent = data.humidity + ' %';
            }
            
            // Update timestamps
            if (data.timestamp) {
                document.getElementById('tempTime').textContent = 'Last updated: ' + data.timestamp;
                document.getElementById('humTime').textContent = 'Last updated: ' + data.timestamp;
            }
        }
    }, (error) => {
        console.error("Error reading sensor data:", error);
        document.getElementById('temp').textContent = 'Error';
        document.getElementById('hum').textContent = 'Error';
    });

    // Listen for notification logs from ESP32
    // ESP32 uploads to: /smartglasses/notifications/notif_X with {type, from, message, timestamp}
    const notificationsRef = ref(database, 'smartglasses/notifications');
    onValue(notificationsRef, (snapshot) => {
        const logDiv = document.getElementById('log');
        const notifications = snapshot.val();
        
        if (notifications && Object.keys(notifications).length > 0) {
            console.log("Received notifications:", notifications);
            
            // Convert to array and sort by key (newest first)
            const notifArray = Object.entries(notifications).map(([key, notif]) => ({
                key,
                ...notif
            }));
            
            // Sort by notification number (extract number from notif_X)
            notifArray.sort((a, b) => {
                const numA = parseInt(a.key.replace('notif_', ''));
                const numB = parseInt(b.key.replace('notif_', ''));
                return numB - numA; // Newest first
            });
            
            logDiv.innerHTML = '';
            
            notifArray.forEach((notif) => {
                const p = document.createElement('p');
                p.className = 'log-entry';
                
                // Create type badge
                const typeBadge = document.createElement('span');
                typeBadge.className = `log-type ${notif.type.toLowerCase()}`;
                typeBadge.textContent = notif.type;
                
                // Create message content
                const content = document.createElement('span');
                let messageText = '';
                
                if (notif.type === 'CALL') {
                    messageText = `üìû Incoming call from ${notif.from || 'Unknown'}`;
                } else if (notif.type === 'MSG') {
                    messageText = `üí¨ ${notif.from || 'Message'}: ${notif.message || ''}`;
                } else if (notif.type === 'NOTIF') {
                    messageText = `üîî ${notif.from || 'Notification'}: ${notif.message || ''}`;
                } else if (notif.type === 'TEST') {
                    messageText = `üß™ ${notif.message || 'Test message'}`;
                } else {
                    messageText = notif.message || 'No message';
                }
                
                content.textContent = messageText;
                
                // Create timestamp
                const timestamp = document.createElement('div');
                timestamp.style.fontSize = '0.8rem';
                timestamp.style.opacity = '0.6';
                timestamp.style.marginTop = '5px';
                timestamp.textContent = notif.timestamp || 'No timestamp';
                
                p.appendChild(typeBadge);
                p.appendChild(content);
                p.appendChild(timestamp);
                logDiv.appendChild(p);
            });
            
        } else {
            logDiv.innerHTML = '<p style="opacity:0.6;">No notifications yet. Waiting for data...</p>';
        }
    }, (error) => {
        console.error("Error reading notifications:", error);
    });

    // Send message function - writes to /smartglasses/webMessage for ESP32 to read
    window.sendMessage = async function() {
        const msgInput = document.getElementById('msg');
        const message = msgInput.value.trim();
        
        if (!message) {
            alert('Please enter a message');
            return;
        }

        if (!isConnected) {
            alert('Not connected to Firebase. Please check your connection.');
            return;
        }

        try {
            // Send message to Firebase - ESP32 reads from /smartglasses/webMessage
            await set(ref(database, 'smartglasses/webMessage'), message);
            
            msgInput.value = '';
            console.log('Message sent to Firebase for ESP32:', message);
            
            // Show success feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úì Message Sent!';
            button.style.background = 'linear-gradient(135deg, #00ff88, #00d4ff)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = 'linear-gradient(135deg, #00d4ff, #9d00ff)';
            }, 2000);
            
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message: ' + error.message);
        }
    }

    // Listen for QR code detections from Python script
    const qrDetectionsRef = ref(database, 'smartglasses/qr_detections');
    onValue(qrDetectionsRef, (snapshot) => {
        const qrLog = document.getElementById('qrLog');
        const detections = snapshot.val();
        
        if (detections && Object.keys(detections).length > 0) {
            console.log("Received QR detections:", detections);
            
            // Convert to array and sort by timestamp (newest first)
            const qrArray = Object.entries(detections).map(([key, qr]) => ({
                key,
                ...qr
            }));
            
            // Sort by timestamp or key
            qrArray.sort((a, b) => {
                // Try to sort by timestamp if available
                if (a.timestamp && b.timestamp) {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                }
                return b.key.localeCompare(a.key);
            });
            
            qrLog.innerHTML = '';
            
            qrArray.forEach((qr) => {
                const div = document.createElement('div');
                div.className = 'qr-entry';
                
                // Create badge
                const badge = document.createElement('span');
                badge.className = `qr-badge ${qr.is_url ? 'url' : 'text'}`;
                badge.textContent = qr.is_url ? 'üåê URL' : 'üìù TEXT';
                
                // Create status
                const status = document.createElement('span');
                status.style.fontSize = '0.8rem';
                status.style.opacity = '0.7';
                status.style.marginLeft = '10px';
                status.textContent = qr.status === 'opened' ? '‚úì Opened' : '‚óè Detected';
                
                // Create data display
                const data = document.createElement('div');
                data.style.marginTop = '10px';
                data.style.fontSize = '1rem';
                data.style.wordBreak = 'break-all';
                
                if (qr.is_url) {
                    // If it's a URL, make it clickable
                    const link = document.createElement('a');
                    link.href = qr.data;
                    link.className = 'qr-link';
                    link.target = '_blank';
                    link.textContent = qr.data;
                    data.appendChild(link);
                } else {
                    data.textContent = qr.data;
                }
                
                // Create timestamp
                const timestamp = document.createElement('div');
                timestamp.style.fontSize = '0.8rem';
                timestamp.style.opacity = '0.6';
                timestamp.style.marginTop = '8px';
                timestamp.textContent = qr.timestamp || 'No timestamp';
                
                div.appendChild(badge);
                div.appendChild(status);
                div.appendChild(data);
                div.appendChild(timestamp);
                qrLog.appendChild(div);
            });
            
        } else {
            qrLog.innerHTML = '<p style="opacity:0.6;">No QR codes detected yet...</p>';
        }
    }, (error) => {
        console.error("Error reading QR detections:", error);
    });

    // Listen for QR code detections from Python script
    const qrDetectionsRef = ref(database, 'smartglasses/qr_detections');
    onValue(qrDetectionsRef, (snapshot) => {
        const qrLog = document.getElementById('qrLog');
        const detections = snapshot.val();
        
        if (detections && Object.keys(detections).length > 0) {
            console.log("Received QR detections:", detections);
            
            // Convert to array and sort by timestamp (newest first)
            const qrArray = Object.entries(detections).map(([key, qr]) => ({
                key,
                ...qr
            }));
            
            // Sort by timestamp or key
            qrArray.sort((a, b) => {
                if (a.timestamp && b.timestamp) {
                    return new Date(b.timestamp) - new Date(a.timestamp);
                }
                return b.key.localeCompare(a.key);
            });
            
            qrLog.innerHTML = '';
            
            qrArray.forEach((qr) => {
                const div = document.createElement('div');
                div.className = 'qr-entry';
                
                // Create badge
                const badge = document.createElement('span');
                badge.className = `qr-badge ${qr.is_url ? 'url' : 'text'}`;
                badge.textContent = qr.is_url ? 'üåê URL' : 'üìù TEXT';
                
                // Create status
                const status = document.createElement('span');
                status.style.fontSize = '0.8rem';
                status.style.opacity = '0.7';
                status.style.marginLeft = '10px';
                status.textContent = qr.status === 'opened' ? '‚úì Opened' : '‚óè Detected';
                
                // Create data display
                const data = document.createElement('div');
                data.style.marginTop = '10px';
                data.style.fontSize = '1rem';
                data.style.wordBreak = 'break-all';
                
                if (qr.is_url) {
                    // If it's a URL, make it clickable
                    const link = document.createElement('a');
                    link.href = qr.data;
                    link.className = 'qr-link';
                    link.target = '_blank';
                    link.textContent = qr.data;
                    data.appendChild(link);
                } else {
                    data.textContent = qr.data;
                }
                
                // Create timestamp
                const timestamp = document.createElement('div');
                timestamp.style.fontSize = '0.8rem';
                timestamp.style.opacity = '0.6';
                timestamp.style.marginTop = '8px';
                timestamp.textContent = qr.timestamp || 'No timestamp';
                
                div.appendChild(badge);
                div.appendChild(status);
                div.appendChild(data);
                div.appendChild(timestamp);
                qrLog.appendChild(div);
            });
            
        } else {
            qrLog.innerHTML = '<p style="opacity:0.6;">No QR codes detected yet...</p><p style="opacity:0.5; font-size: 0.9rem; margin-top: 10px;">Run the Python QR scanner to detect codes</p>';
        }
    }, (error) => {
        console.error("Error reading QR detections:", error);
    });

    // Camera feed handling
    let lastFrameTimestamp = null;
    let frameCount = 0;
    let lastFpsUpdate = Date.now();
    let currentFps = 0;

    const cameraRef = ref(database, 'smartglasses/camera');
    onValue(cameraRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.frame) {
            console.log("Received camera frame");
            
            const cameraImg = document.getElementById('cameraStream');
            const placeholder = document.getElementById('cameraPlaceholder');
            const statusDot = document.getElementById('camStatusDot');
            const statusLabel = document.getElementById('camStatusLabel');
            const lastFrameTimeEl = document.getElementById('lastFrameTime');
            
            // Update image
            cameraImg.src = 'data:image/jpeg;base64,' + data.frame;
            cameraImg.style.display = 'block';
            placeholder.style.display = 'none';
            
            // Update status
            statusDot.classList.add('live');
            statusLabel.textContent = 'Live';
            
            // Update timestamp
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            lastFrameTimeEl.textContent = 'Last frame: ' + timeStr;
            lastFrameTimestamp = Date.now();
            
            // Calculate FPS
            frameCount++;
            const elapsed = (Date.now() - lastFpsUpdate) / 1000;
            if (elapsed >= 1.0) {
                currentFps = frameCount / elapsed;
                document.getElementById('fpsCounter').textContent = 'FPS: ' + currentFps.toFixed(1);
                frameCount = 0;
                lastFpsUpdate = Date.now();
            }
        }
    }, (error) => {
        console.error("Error reading camera feed:", error);
        document.getElementById('cameraStatusText').textContent = 'Error loading camera feed';
    });

    // Monitor camera freshness (mark offline if no frames for 10 seconds)
    setInterval(() => {
        if (lastFrameTimestamp && (Date.now() - lastFrameTimestamp > 10000)) {
            document.getElementById('camStatusDot').classList.remove('live');
            document.getElementById('camStatusLabel').textContent = 'Offline';
            document.getElementById('fpsCounter').textContent = 'FPS: 0.0';
        }
    }, 5000);

    // Allow Enter key to send message
    document.getElementById('msg').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>

</body>
</html>